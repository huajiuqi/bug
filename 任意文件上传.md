




#   ThinkCMF 6.0.9 文件上传

## 源码信息

[ThinkCMF: ThinkCMF是一款支持Swoole的开源内容管理框架，基于ThinkPHP开发，同时支持PHP-FPM和Swoole双模式，让WEB开发更快! (gitee.com)](https://gitee.com/thinkcmf/ThinkCMF)
![image-2024222466948.png](/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/assets/image-2024222466948.png)
## 代码分析

发现网站存在编辑器功能点  
![image-20242223652626.png](./image-20242223652626.png)

找到图片上传进行抓包 找到代码文件的对应函数
![image-2024222383526.png](/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/assets/image-2024222383526.png)
![image-2024222402749.png](/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/assets/image-2024222402749.png)


根据upload函数内的代码以及请求包传参的action 的值 进入ueditorUpload("image"); 函数内
 在ueditorUpload函数内273行 对上传的文件进行了处理并且将返回值给到$result


![image-20242225114529.png](/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/assets/image-20242225114529.png)
其中文件上传以及返回包内容部分在Upload类中完成其中主要在103-110行对上传文件的后缀进行了过滤

![image-2024222304310.png](/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/assets/image-2024222304310.png)

其中103行是
![image-20242223324481.png](/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/assets/image-20242223324481.png)


105行是
![image-20242223449314.png](/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/assets/image-20242223449314.png)

最后的if判断  后缀名是否不在允许的后缀名中，判断后缀名是不是等于php  满足其中一条的则直接返回 非法文件类型 
```
if (!in_array($strFileExtension, $arrAllowedExtensions) || $strFileExtension == 'php') {  
    $this->error = "非法文件类型！";  
    return false;  
}
```
如果两个条件都不满足则可以通过这个if判断 从而执行下面的代码完成文件上传

![image-20242223947934.png](/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/assets/image-20242223947934.png)


在上传设置这里加上php::$dada  (利用windows的特性创建的php::$dada后缀的文件最终会创建出php后缀文件)  这样上传一个php::$dada后缀的文件既可通过上面的if判断
![image-20242225429938.png](/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/assets/image-20242225429938.png)


进行上传，成功绕过过滤 上传上去一个php文件
![image-2024222289201.png](/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/assets/image-2024222289201.png)

![image-20242222339965.png](/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/assets/image-20242222339965.png)

## 漏洞利用



将一个包含shell代码的php文件改为png后缀 绕过前端限制 进行上传
![image-20242223556823.png](/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/assets/image-20242223556823.png)




将png后缀改为php::$data,发送请求包完成上传，成功上传
![image-2024222380861.png](/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/assets/image-2024222380861.png)
![image-20242223841316.png](/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/assets/image-20242223841316.png)


访问url地址 后使用webshell工具进行shell连接

![image-2024222432993.png](/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/assets/image-2024222432993.png)


